#!/bin/bash
EMAIL=geek-alerts@ilovefreegle.org

# path to innobackupex
XTRABACKUP=/usr/bin/innobackupex

# User and password are in [xtrabackup] in ~/.my.cnf
OPTIONS="--stream=tar /backup"
BACKUP="$XTRABACKUP $OPTIONS $BACKUPDIR"

timestamp=$(date +%Y-%m-%d-%H-%M)

# run a backup and stream the output directly
$BACKUP | /root/gsutil/gsutil cp - gs://freegle_backup/iznik-$timestamp.tar > /tmp/gsutil.out 2>&1

if [ $? == 0 ]; then
  if [ $? == 0 ]; then
    cat /tmp/gsutil.out | mail -s "BACKUP SUCCESS: backed up to $BACKUPDIR/$MOST_RECENT" $EMAIL
  else
    echo "Couldn't apply the binary logs to the backup $BACKUPDIR/$MOST_RECENT" | mail -s "BACKUP ERRO: Mysql binary log didn't get applied to backup" $EMAIL
  fi
else
   # problem with initial backup :(
   echo "Couldn't do a mysql backup" | mail -s "BACKUP ERROR: Mysql backup failed" $EMAIL
fi